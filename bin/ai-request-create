#!/usr/bin/env python3
from json import dumps, load
from sys import argv, stdin
from os import environ


def main():
    model = environ["OPENAI_MODEL"]
    temperature = float(environ.get("OPENAI_TEMPERATURE", 0))
    instruction = " ".join(argv[1:])
    data = stdin.read()
    request = create_request(model, temperature, instruction, data)
    schema = environ.get("OPENAI_SCHEMA", None)
    if schema:
        with open(schema, "rb") as file:
            request = request | create_tool(load(file))
    print(dumps(request, indent=4))


def create_request(model: str, temperature: float, instruction: str, data: str) -> dict:
    return {
        "model": model,
        "messages": [
            {"role": "system", "content": instruction},
            {"role": "user", "content": data},
        ],
        "temperature": temperature,
    }


def create_tool(parameters: dict) -> dict:
    return {
        "tools": [
            {
                "type": "function",
                "function": {"name": "function", "parameters": parameters},
            }
        ],
        "tool_choice": {
            "type": "function",
            "function": {
                "name": "function",
            },
        },
    }


if __name__ == "__main__":
    main()

#!/usr/bin/env python3
from base64 import b64decode
from sys import argv, stdin
from io import BytesIO
from faiss import IndexFlatIP, write_index
from numpy import load, expand_dims


def main():
    filepath = argv[1]
    index = None
    for line in stdin:
        array = to_array(line.strip())
        if len(array.shape) == 1:
            array = expand_dims(array, axis=0)
        if index is None:
            dims = array.shape[-1]
            index = IndexFlatIP(dims)
        index.add(array)  # pylint: disable=no-value-for-parameter
    write_index(index, filepath)


def to_array(string):
    return load(BytesIO(b64decode(string)))


if __name__ == "__main__":
    main()

#!/usr/bin/env python3
from sys import argv, stdin, stdout
from base64 import b64decode
from io import BytesIO
from numpy import load, expand_dims, savetxt
from faiss import read_index


def main():
    filepath = argv[1]
    count = int(argv[2])
    index = read_index(filepath)
    count = min(count, index.ntotal)
    for line in stdin:
        array = to_array(line.strip())
        if len(array.shape) == 1:
            array = expand_dims(array, axis=0)
        _, indices = index.search(array, count)
        savetxt(stdout, indices + 1, fmt="%d")


def to_array(string):
    return load(BytesIO(b64decode(string)))


if __name__ == "__main__":
    main()
